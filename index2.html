<html>
<head>
<!-- box2djs -->
<script src="vendors/box2d/lib/prototype-1.6.0.2.js"></script>
<script src='vendors/box2d/js/box2d/common/b2Settings.js'></script>
<script src='vendors/box2d/js/box2d/common/math/b2Vec2.js'></script>
<script src='vendors/box2d/js/box2d/common/math/b2Mat22.js'></script>
<script src='vendors/box2d/js/box2d/common/math/b2Math.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2AABB.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2Bound.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2BoundValues.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2Pair.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2PairCallback.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2BufferedPair.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2PairManager.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2BroadPhase.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2Collision.js'></script>
<script src='vendors/box2d/js/box2d/collision/Features.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2ContactID.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2ContactPoint.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2Distance.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2Manifold.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2OBB.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2Proxy.js'></script>
<script src='vendors/box2d/js/box2d/collision/ClipVertex.js'></script>
<script src='vendors/box2d/js/box2d/collision/shapes/b2Shape.js'></script>
<script src='vendors/box2d/js/box2d/collision/shapes/b2ShapeDef.js'></script>
<script src='vendors/box2d/js/box2d/collision/shapes/b2BoxDef.js'></script>
<script src='vendors/box2d/js/box2d/collision/shapes/b2CircleDef.js'></script>
<script src='vendors/box2d/js/box2d/collision/shapes/b2CircleShape.js'></script>
<script src='vendors/box2d/js/box2d/collision/shapes/b2MassData.js'></script>
<script src='vendors/box2d/js/box2d/collision/shapes/b2PolyDef.js'></script>
<script src='vendors/box2d/js/box2d/collision/shapes/b2PolyShape.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/b2Body.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/b2BodyDef.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/b2CollisionFilter.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/b2Island.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/b2TimeStep.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2ContactNode.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2Contact.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2ContactConstraint.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2ContactConstraintPoint.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2ContactRegister.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2ContactSolver.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2CircleContact.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2Conservative.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2NullContact.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2PolyAndCircleContact.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2PolyContact.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/b2ContactManager.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/b2World.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/b2WorldListener.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2JointNode.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2Joint.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2JointDef.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2DistanceJoint.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2DistanceJointDef.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2Jacobian.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2GearJoint.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2GearJointDef.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2MouseJoint.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2MouseJointDef.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2PrismaticJoint.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2PrismaticJointDef.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2PulleyJoint.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2PulleyJointDef.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2RevoluteJoint.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2RevoluteJointDef.js'></script>

<script>
var state;

function GameState(){
		
	this.draw = function(){
		var ctx = document.getElementById('cv').getContext('2d');
		
		// Background
		var x0 = 0, y0 = 0, height = 600, width = 1300;
			
		ctx.save();
		ctx.rect(x0, y0, width, height);
		ctx.fillStyle = "black";
		ctx.fill();
		ctx.strokeStyle = "black";
		ctx.stroke();
		
		// Static scene stack
		var fabrice={}
		fabrice.scene = [
			{
				name : "La luna del cacciatore",
				location : 
				{
					x : 1300*6/8,
					y : 600*1/6
				},
				image : "red_moon.png"
			}
		];
		
		
		// Draw objects
		objects = [
			{
				name : "level",
				location : {
					x : -300,
					y : 400
				},
				image:"level0.png"			
			},
			{
				name : "zombie1",
				location : 
				{
					x : 30,
					y : 30
				},
				image : "zombie2.png"
			},
			{
				name : "zombie2",
				location : 
				{
					x : 90,
					y : 30
				},
				image : "zombie2.png"
			},
			{
				name : "zombie3",
				location : 
				{
					x : 150,
					y : 30
				},
				image : "zombie.png"
			},
			{
				name : "zombie4",
				location : 
				{
					x : 210,
					y : 30
				},
				image : "zombie.png"
			}
		];
		
		// Build scene
		(function(){
				
				for(var i in fabrice.scene){
					/*
					The physics engine bloats maps with properties ...
					*/

					if(!fabrice.scene[i].image || !fabrice.scene[i].location)
						continue;
					
					alert(fabrice.scene[i].image);
					
					var sceneObj = new Image();
					sceneObj.onload = function(){			
						ctx.drawImage(sceneObj, sceneObj.obj.location.x, sceneObj.obj.location.y);
					}
					//alert(fabrice.scene[i])
					//alert('scene: ' + fabrice.scene[i].image);
					sceneObj.src = fabrice.scene[i].image;
					sceneObj.obj = fabrice.scene[i];
				}
				
		})();


		to_load = {}
		uniques = 0;
		// Build unique hash for image loading
		for(var i in objects){
			var o = objects[i];
			if(!o.image)
				continue;
			
			if(!to_load[o.image]){				
				to_load[o.image] = {
					loaded : false
				};
				uniques ++;
			}
		}
		
		// Load images. Use assync callback to check until all images are loaded, then draw images
		loaded = 0;
		for(var key in to_load){
			if(!to_load[key])
				continue;

			to_load[key].obj = new Image();						
			to_load[key].obj.onload = function(){
				loaded++;
				//alert('key = ' + key)
				
				to_load[key].loaded = true;
				//alert(loaded)
				if(loaded >= uniques){
					//alert(to_load['zombie.png'].obj)
					//alert(to_load['zombie2.png'].obj)
					// Draw every object
					for(var i in objects){
						var o = objects[i];
						if(!to_load[o.image])
							continue;

						ctx.drawImage(to_load[o.image].obj, o.location.x, o.location.y);
					}
				}
			};
			to_load[key].obj.src = key;
		}
		
	};
	
	return this;
}

function MenuState(){
	this.selected = 0;
	var selected = this.selected;
	
	this.draw = function(){
			var ctx = document.getElementById('cv').getContext('2d');
			
			// Background
			var x0 = 0, y0 = 0, height = 600, width = 1300;
			
			ctx.save();
			
			ctx.beginPath();
			ctx.rect(x0, y0, width, height);
			ctx.fillStyle = "black";
			ctx.fill();
			ctx.strokeStyle = "black";
			ctx.stroke();
			
			// Title
			ctx.font = "45pt Calibri";
			ctx.textAlign = "center";
			ctx.fillStyle = "white";
			ctx.fillText("ZOMBIE APOCALYPSE", 1300/2, 600*1/5);
			
			// Menu 
			ctx.restore();
			ctx.font = "30pt Calibri";
			ctx.textAlign = "center";
			
			// 1st option
			ctx.fillStyle = (selected == 0 ? "yellow" : "white");
			ctx.fillText("New Game",    1300/2 , 600*3/5);
			
			// 2nd option
			ctx.fillStyle = (selected == 1 ? "yellow" : "white");
			ctx.fillText("High Scores", 1300/2 , 600*4/5);
	};
	var draw = this.draw;
	
	this.keydown = {}
	this.keydown[13] = function(){ 
		state = new GameState();		
		state.draw();
		window.removeEventListener('keydown');
	};
	this.keydown[40] = function(){ selected = (selected + 1) % 2; draw(); };
	this.keydown[38] = function(){ selected = Math.abs((selected - 1) % 2); draw(); };
	
	var key_actions = this.keydown;
	
	window.addEventListener('keydown', function(evt){	
		if(key_actions[evt.keyCode]){
			key_actions[evt.keyCode]()
		}
	}, true);
	
	// use window.removeEventListener to unregister
	
	return this;
}

window.onload = function(){
	state = new GameState(); //MenuState(); // 
	state.draw();	
}

</script>
</head>
<body>
<canvas id="cv" width="1300" height="600">
</canvas>
</body>
</html>