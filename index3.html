<html>
<head>
<script src="vendors\box2d\Box2d.min.js"></script>
<!-- box2djs 
<script src="vendors/box2d/lib/prototype-1.6.0.2.js"></script>
<script src='vendors/box2d/js/box2d/common/b2Settings.js'></script>
<script src='vendors/box2d/js/box2d/common/math/b2Vec2.js'></script>
<script src='vendors/box2d/js/box2d/common/math/b2Mat22.js'></script>
<script src='vendors/box2d/js/box2d/common/math/b2Math.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2AABB.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2Bound.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2BoundValues.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2Pair.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2PairCallback.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2BufferedPair.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2PairManager.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2BroadPhase.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2Collision.js'></script>
<script src='vendors/box2d/js/box2d/collision/Features.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2ContactID.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2ContactPoint.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2Distance.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2Manifold.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2OBB.js'></script>
<script src='vendors/box2d/js/box2d/collision/b2Proxy.js'></script>
<script src='vendors/box2d/js/box2d/collision/ClipVertex.js'></script>
<script src='vendors/box2d/js/box2d/collision/shapes/b2Shape.js'></script>
<script src='vendors/box2d/js/box2d/collision/shapes/b2ShapeDef.js'></script>
<script src='vendors/box2d/js/box2d/collision/shapes/b2BoxDef.js'></script>
<script src='vendors/box2d/js/box2d/collision/shapes/b2CircleDef.js'></script>
<script src='vendors/box2d/js/box2d/collision/shapes/b2CircleShape.js'></script>
<script src='vendors/box2d/js/box2d/collision/shapes/b2MassData.js'></script>
<script src='vendors/box2d/js/box2d/collision/shapes/b2PolyDef.js'></script>
<script src='vendors/box2d/js/box2d/collision/shapes/b2PolyShape.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/b2Body.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/b2BodyDef.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/b2CollisionFilter.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/b2Island.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/b2TimeStep.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2ContactNode.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2Contact.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2ContactConstraint.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2ContactConstraintPoint.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2ContactRegister.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2ContactSolver.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2CircleContact.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2Conservative.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2NullContact.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2PolyAndCircleContact.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/contacts/b2PolyContact.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/b2ContactManager.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/b2World.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/b2WorldListener.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2JointNode.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2Joint.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2JointDef.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2DistanceJoint.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2DistanceJointDef.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2Jacobian.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2GearJoint.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2GearJointDef.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2MouseJoint.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2MouseJointDef.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2PrismaticJoint.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2PrismaticJointDef.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2PulleyJoint.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2PulleyJointDef.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2RevoluteJoint.js'></script>
<script src='vendors/box2d/js/box2d/dynamics/joints/b2RevoluteJointDef.js'></script>
-->
<script>
var state;


// http://paulirish.com/2011/requestanimationframe-for-smart-animating/ 
window.requestAnimFrame = (function(){
	return  window.requestAnimationFrame     || 
		  window.webkitRequestAnimationFrame || 
		  window.mozRequestAnimationFrame    || 
		  window.oRequestAnimationFrame      || 
		  window.msRequestAnimationFrame     || 
		  function(/* function */ callback, /* DOMElement */ element){
			window.setTimeout(callback, 1000 / 60);
		  };
})();

var SCALE = 30;

function ImageStore(){
	this.images = {};
}

/***
 * Loads an image into the store if it isn't in it yet. Returns the object in the store.
 */
ImageStore.prototype.requestImage = function (path){
	if(!this.images[path]){
		// If isn't loaded yet, load it yourself
		this.images[path] = {
			obj		: new Image(),
			loaded	: false
		};
		var images = this.images;
		this.images[path].obj.onload = function (){
			images[path].loaded = true;
		};
		this.images[path].obj.src = path;
	}

	return this.images[path];
}

/***
 * Returns an image from the store. If the image is not in the store if it isn't loaded yet, returns null;
 */
ImageStore.prototype.getImage = function (path){
	if(this.images[path] && this.images[path].obj && this.images[path].loaded){
		return this.images[path].obj;
	}
	
	return null;
}

var store = new ImageStore();
store.requestImage('zombie2.png');
store.requestImage('zombie.png');
store.requestImage('red_moon.png');

function Entity(id, x, y, img_name){
	this.id 	= id;
	this.x 		= x;
	this.y 		= y;
	this.angle 	= 0;
	this.img_name = img_name;
}

Entity.prototype.update = function(state){
	this.x = state.x;
	this.y = state.y;
	this.angle = state.a;
}

Entity.prototype.draw = function(ctx){
	/**/
	ctx.save();
	ctx.fillStyle = 'black';
	ctx.beginPath();
	ctx.arc(this.x * SCALE, this.y * SCALE, 2, 0, Math.PI * 2, true);
	ctx.closePath();
	ctx.fill();
	ctx.restore();
	
	var img = store.getImage(this.img_name);
	
	ctx.save();		
	ctx.translate(this.x * SCALE /*+ img.width*1/2*/, this.y * SCALE /*+ img.height*1/2*/); // Move to origin of image
	ctx.rotate(Math.PI * 0.12);
	ctx.translate(-this.x * SCALE /*- img.width*1/2*/, -this.y * SCALE /*- img.height*1/2*/); // Undo move
	ctx.drawImage(img, this.x * SCALE - img.width*1/2, this.y * SCALE - img.height);
	ctx.restore();
}

function GameState(){
/*
	var world;
	var dyn1;
	
	this.init = function(){
		// Nice aliases
	    var   b2Vec2 = Box2D.Common.Math.b2Vec2
				, b2BodyDef = Box2D.Dynamics.b2BodyDef
				, b2Body = Box2D.Dynamics.b2Body
				, b2FixtureDef = Box2D.Dynamics.b2FixtureDef
				, b2Fixture = Box2D.Dynamics.b2Fixture
				, b2World = Box2D.Dynamics.b2World
				, b2MassData = Box2D.Collision.Shapes.b2MassData
				, b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape
				, b2CircleShape = Box2D.Collision.Shapes.b2CircleShape
				, b2DebugDraw = Box2D.Dynamics.b2DebugDraw;

		world = new b2World(new b2Vec2(0, 10) /*gravity /, true /*allow sleep /);
		
		var SCALE = 30;	
		
		// Create ground fixture
		var fixDef = new b2FixtureDef();
		fixDef.density     = 1.0;
		fixDef.friction    = 0.5;
		fixDef.restitution = 0.8;
		
		// Create ground body
		var bodyDef = new b2BodyDef();
		bodyDef.type = b2Body.b2_staticBody;
		bodyDef.position.x = 1300 / 2 / SCALE;
		bodyDef.position.y = 600 / SCALE - 1;
		
		// Create ground shape
		fixDef.shape = new b2PolygonShape();
		fixDef.shape.SetAsBox(1300 / SCALE / 2, 0.5 / 2);
		world.CreateBody(bodyDef).CreateFixture(fixDef);
		
		//create dynamic circle object
		bodyDef.type = b2Body.b2_dynamicBody;
		fixDef.shape = new b2CircleShape(0.5 /*radius /);
		bodyDef.position.x = 25;
		bodyDef.position.y = 10;
		dyn1 = world.CreateBody(bodyDef);
		dyn1.CreateFixture(fixDef);
		
		// setup debug draw
		var debugDraw = new b2DebugDraw();
		debugDraw.SetSprite( document.getElementById('cv').getContext('2d') );
		debugDraw.SetDrawScale( SCALE );
		debugDraw.SetFillAlpha( 0.3 );
		debugDraw.SetLineThickness( 2.0 );
		debugDraw.SetFlags( b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
		world.SetDebugDraw(debugDraw);
	};
	
	this.init();
	*/
	
	var to_load = {};
	var uniques = 0;
	
	this.draw = function(){
		//return;
		
		var ctx = document.getElementById('cv').getContext('2d');
		
		// Background
		var x0 = 0, y0 = 0, height = 600, width = 1300;
		/*
		ctx.save();
		ctx.rect(x0, y0, width, height);
		ctx.fillStyle = "black";
		ctx.fill();
		ctx.strokeStyle = "black";
		ctx.stroke();
		*/
		
		// Static scene stack
		var fabrice={}
		fabrice.scene = [
			{
				name : "La luna del cacciatore",
				location : 
				{
					x : 1300*6/8,
					y : 600*1/6
				},
				image : "red_moon.png"
			}
		];

		// Draw objects
		objects = [
			/**/{
				name : "level",
				location : {
					x : -300,
					y : 400
				},
				image:"level0.png"
			},
			{
				name : "zombie1",
				location : 
				{
					x : 0,
					y : 0
				},
				image : "zombie2.png"
			},
			{
				name : "zombie2",
				location : 
				{
					x : 90,
					y : 30
				},
				image : "zombie2.png"
			},
			{
				name : "zombie3",
				location : 
				{
					x : 150,
					y : 30
				},
				image : "zombie.png"
			},
			{
				name : "zombie4",
				location : 
				{
					x : 210,
					y : 30
				},
				image : "zombie.png"
			}
		];
		
		// Build scene
		(function(){
				
				for(var i in fabrice.scene){
					/*
					The physics engine bloats maps with properties ...
					*/

					if(!fabrice.scene[i].image || !fabrice.scene[i].location)
						continue;
					
					//alert(fabrice.scene[i].image);
					
					var sceneObj = store.getImage('red_moon.png');
					//sceneObj.onload = function(){			
					ctx.drawImage(sceneObj, fabrice.scene[i].location.x, fabrice.scene[i].location.y);
					//}
					//alert(fabrice.scene[i])
					//alert('scene: ' + fabrice.scene[i].image);
					//sceneObj.src = fabrice.scene[i].image;
					//sceneObj.obj = fabrice.scene[i];
				}
				
		})();

		var draw_all = function (){
			for(var i in objects){
						var o = objects[i];
						if(!to_load[o.image])
							continue;

						ctx.drawImage(to_load[o.image].obj, o.location.x, o.location.y);
					}
		};
		
		// Build unique hash for image loading
		if(uniques == 0){
			//alert('hello')
			
			for(var i in objects){
				var o = objects[i];
				if(!o.image)
					continue;
				
				if(!to_load[o.image]){				
					to_load[o.image] = {
						loaded : false
					};
					uniques ++;
				}
			}
			
			// Load images. Use assync callback to check until all images are loaded, then draw images
			loaded = 0;
			for(var key in to_load){
				if(!to_load[key])
					continue;

				to_load[key].obj = new Image();						
				to_load[key].obj.onload = function(){
					loaded++;
					//alert('key = ' + key)
					
					to_load[key].loaded = true;
					//alert(loaded)
					if(loaded >= uniques){
						// Draw object
						draw_all();
					}
				};
				to_load[key].obj.src = key;
			}
			
		}else{
			// Draw objects
			draw_all();
		}		
	};
	var draw = this.draw;
	/*	
	function update(){
		//alert("hello");
		//state.draw();
		
		world.Step(1/60 /*frame-rate /, 10 /*velocity iterations /, 10 /*position iterations /);
		world.DrawDebugData();
		world.ClearForces();
		
		requestAnimFrame(update);
	}
	
	requestAnimFrame(update);
	*/
	
	// Create list of entities
	var world = {};
	for(var i = 0; i < 5; i++){
		world[i] = new Entity(i, i * 5 + 5, 2, i % 2 ? 'zombie2.png' : 'zombie.png' );
	}
	
	var worker = new Worker('world.js');
	worker.postMessage(world);
	
	worker.onmessage = function(e){		
		for(var id in e.data){
			var entity = world[id];
			if(entity){
				entity.update(e.data[id]);
			}
		}
	};
	
	var ctx = document.getElementById('cv').getContext('2d');
	
	(function loop(){
		ctx.clearRect(0,0,1300,600);
		draw();
		for(var id in world){
			var entity = world[id];
			entity.draw(ctx);
		}
		requestAnimFrame(loop);
	})();
	
	return this;
}

function MenuState(){
	this.selected = 0;
	var selected = this.selected;
	
	this.draw = function(){
			var ctx = document.getElementById('cv').getContext('2d');
			
			// Background
			var x0 = 0, y0 = 0, height = 600, width = 1300;
			
			ctx.save();
			
			ctx.beginPath();
			ctx.rect(x0, y0, width, height);
			ctx.fillStyle = "black";
			ctx.fill();
			ctx.strokeStyle = "black";
			ctx.stroke();
			
			// Title
			ctx.font = "45pt Calibri";
			ctx.textAlign = "center";
			ctx.fillStyle = "white";
			ctx.fillText("ZOMBIE APOCALYPSE", 1300/2, 600*1/5);
			
			// Menu 
			ctx.restore();
			ctx.font = "30pt Calibri";
			ctx.textAlign = "center";
			
			// 1st option
			ctx.fillStyle = (selected == 0 ? "yellow" : "white");
			ctx.fillText("New Game",    1300/2 , 600*3/5);
			
			// 2nd option
			ctx.fillStyle = (selected == 1 ? "yellow" : "white");
			ctx.fillText("High Scores", 1300/2 , 600*4/5);
	};
	var draw = this.draw;
	
	this.keydown = {}
	this.keydown[13] = function(){ 
		state = new GameState();		
		state.draw();
		window.removeEventListener('keydown');
	};
	this.keydown[40] = function(){ selected = (selected + 1) % 2; draw(); };
	this.keydown[38] = function(){ selected = Math.abs((selected - 1) % 2); draw(); };
	
	var key_actions = this.keydown;
	
	window.addEventListener('keydown', function(evt){	
		if(key_actions[evt.keyCode]){
			key_actions[evt.keyCode]()
		}
	}, true);
	
	// use window.removeEventListener to unregister
	
	return this;
}

window.onload = function(){
	state = new GameState(); //MenuState(); // 
	//state.draw();	
}

</script>
</head>
<body>
<canvas id="cv" width="1300" height="600">
</canvas>
</body>
</html>