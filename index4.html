<html>
<head>

<script src="vendors/box2d/Box2d.min.js"></script>
<script src="world_index4.js"></script>
<script>

var WIDTH = 600, HEIGHT = 600;

function Movable(){
}
Movable.prototype.update = function(state){
	if(this.x) this.x = state.x;
	if(this.y) this.y = state.y;
}

/* World - background */

function World(width, height){
	this.width = width;
	this.height = height;
}

World.prototype.draw = function(ctx){
	ctx.clearRect(0,0,this.width,this.height);
	
	ctx.beginPath();
	ctx.rect(0,0,this.width,this.height);
	ctx.fillStyle="black";
	ctx.fill();
	ctx.lineWidth=1;
	ctx.strokeStyle="black";
	ctx.stroke();
}

/* Barriers - fixed */

function Barrier(){
	this.x = this.y = this.radius = -1;
}

Barrier.prototype.draw = function (ctx){
	ctx.beginPath();
	ctx.arc(this.x, this.y, this.radius, 0, 2*Math.PI, false);
	ctx.fillStyle="red";
	ctx.fill();
	ctx.lineWidth=1;
	ctx.strokeStyle="red";
	ctx.stroke();
}

function BarrierTopLeft(){
	this.x = 0;
	this.y = 0;
	this.radius = 20;
	this.id = 'barrier_topleft';
}
BarrierTopLeft.prototype = new Barrier();
BarrierTopLeft.prototype.constructor = BarrierTopLeft;

function BarrierTopRight(){
	this.x = WIDTH;
	this.y = 0;
	this.radius = 20;
	this.id = 'barrier_topright';
}
BarrierTopRight.prototype = new Barrier();
BarrierTopRight.prototype.constructor = BarrierTopRight;

function BarrierBottomLeft(){
	this.x = 0;
	this.y = HEIGHT;
	this.radius = 20;
	this.id = 'barrier_bottomleft';
}
BarrierBottomLeft.prototype = new Barrier();
BarrierBottomLeft.prototype.constructor = BarrierBottomLeft;

function BarrierBottomRight(){
	this.x = WIDTH;
	this.y = HEIGHT;
	this.radius = 20;
	this.id = 'barrier_bottomright';
}
BarrierBottomRight.prototype = new Barrier();
BarrierBottomRight.prototype.constructor = BarrierBottomRight;

/* Ball - dynamic */
function Ball(){
	this.x = WIDTH/2;
	this.y = HEIGHT/2;
	this.radius = 10;
	this.id = 'ball';
}

Ball.prototype = new Movable();
Ball.prototype.constructor = Ball;
Ball.prototype.draw = function(ctx){
	ctx.beginPath();
	ctx.arc(this.x, this.y, this.radius, 0, 2*Math.PI, false);
	ctx.fillStyle="white";
	ctx.fill();
	ctx.lineWidth=1;
	ctx.strokeStyle="white";
	ctx.stroke();
}

/* Players- dynamic, with constraints */

function Player(){
	this.x = 0;
	this.y = 0;
	this.height = 0;
	this.width = 0;
}
Player.prototype = new Movable();
Player.prototype.constructor = Player;
Player.prototype.draw = function(ctx){
	ctx.beginPath();
	ctx.rect(this.x,this.y,this.width,this.height);
	ctx.fillStyle="white";
	ctx.fill();
	ctx.lineWidth=1;
	ctx.strokeStyle="white";
	ctx.stroke();
}
Player.prototype.update = function(newWorld){
	// x and y need to be fixed ...
	newWorld.x -= this.width / 2;
	newWorld.y -= this.height / 2;
	
	// Regular update
	this.x = newWorld.x;
	this.y = newWorld.y;
}

function PlayerTop(){
	this.x = 40;
	this.y = 5;
	this.height = 5;
	this.width = 100;
	this.id = 'playertop';
}
PlayerTop.prototype = new Player();
PlayerTop.prototype.constructor = PlayerTop;

function PlayerBottom(){
	this.x = 40;
	this.y = HEIGHT - 5 - 5;
	this.height = 5;
	this.width = 100;
	this.id = 'playerbottom';
}
PlayerBottom.prototype = new Player();
PlayerBottom.prototype.constructor = PlayerBottom;

function PlayerLeft(side){
	this.x = 5;
	this.y = 40;
	this.height = 100;
	this.width = 5;
	this.id = 'playerleft';
}
PlayerLeft.prototype = new Player();
PlayerLeft.prototype.constructor = PlayerLeft;


function PlayerRight(side){
	this.x = WIDTH - 5 - 5;
	this.y = 40;
	this.height = 100;
	this.width = 5;	
	this.id = 'playerright';
}
PlayerRight.prototype = new Player();
PlayerRight.prototype.constructor = PlayerRight;


window.requestAnimFrame = (function(){
	return  window.requestAnimationFrame     || 
		  window.webkitRequestAnimationFrame || 
		  window.mozRequestAnimationFrame    || 
		  window.oRequestAnimationFrame      || 
		  window.msRequestAnimationFrame     || 
		  function(/* function */ callback, /* DOMElement */ element){
			window.setTimeout(callback, 1000 / 60);
		  };
})();

window.onload = function(){
	
	var ctx = document.getElementById('cv').getContext('2d');
	
	var world = new World(WIDTH, HEIGHT);
	world.draw(ctx);
	
	var barrier1 = new BarrierTopLeft();
	barrier1.draw(ctx);
	var barrier2 = new BarrierTopRight();
	barrier2.draw(ctx);	
	var barrier3 = new BarrierBottomLeft();
	barrier3.draw(ctx);
	var barrier4 = new BarrierBottomRight();
	barrier4.draw(ctx);
	
	var ball = new Ball();
	ball.draw(ctx);	
	var pleft = new PlayerLeft();
	pleft.draw(ctx);
	var pright = new PlayerRight();
	pright.draw(ctx);
	var ptop = new PlayerTop();
	ptop.draw(ctx);
	var pbottom = new PlayerBottom();
	pbottom.draw(ctx);
	
	var message = {
		barriers : [barrier1, barrier2, barrier3, barrier4],
		ball : ball,
		players  : [pleft, pright, ptop, pbottom],
		all : { }
	};
	
	message.all[barrier1.id]= barrier1 
	message.all[barrier2.id]= barrier2 
	message.all[barrier3.id]= barrier3 
	message.all[barrier4.id]= barrier4
	message.all[ball.id]	= ball 
	message.all[pleft.id]	= pleft
	message.all[pright.id]	= pright
	message.all[ptop.id]	= ptop
	message.all[pbottom.id]	= pbottom
	
	var physics = new PhysicsWorld(30, false, ctx, true);
	physics.setBodies(message);
	
	// Game loop
	(function loop(){
		ctx.clearRect(0,0,600,600)
		
		// update physics state
		physics.update(function(newWorld) {
			//console.log('callback of update');

			// Update entities
			for(var id in newWorld){
				var entity = message.all[id];
				if(entity && entity.update){
					entity.update(newWorld[id]);
				}
			}			
			/*
			world.draw(ctx);		
			// Draw objs
			for(var i in message.all){
				message.all[i].draw(ctx);
			}*/
			
			window.requestAnimFrame(loop);
			if(physics.joint){
				document.getElementById('dbg').innerHTML = 
					'joint transl = ' + physics.joint.GetJointTranslation() +
					', joint speed = ' + physics.joint.GetJointSpeed();
			}
		});
	})();
	
	setTimeout(function(){ physics.applyImpulse(ball.id, 15) }, 500)
	setTimeout(function(){ physics.applyImpulse(pbottom.id, 15) }, 500)
	
};


</script>
</head>
<body>
<canvas id="cv" width="600" height="600">
</canvas>
<p id="dbg">
</p>
</body>
</html>